from pydantic import BaseModel
from typing import Literal, Dict
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from app.service.chat_gpt import llm, llm_4
from typing import Optional
from langchain_core.messages import HumanMessage, AIMessage


# â”€â”€â”€ Supervisor LLM node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

members = [
    "Scheduler",                  # ìº˜ë¦°ë” ì¼ì • ìƒì„±Â·ì¡°íšŒÂ·ìˆ˜ì •Â·ì‚­ì œ
    "Travel_Destination_Searcher",# ì—¬í–‰ì§€Â·ê´€ê´‘ì§€ ê²€ìƒ‰
    "Travel_Planner",             # ì—¬í–‰ ê³„íšì„œ(ì¼ì •í‘œ) ìƒì„±
    "Travel_Itinerary_Share"             # ì—¬í–‰ ê³„íšì„œ ì´ë©”ì¼ ê³µìœ 
]
options = ["FINISH"] + members


system_prompt = """ë‹¹ì‹ ì€ Supervisor ì—ì´ì „íŠ¸ì…ë‹ˆë‹¤. ê° í•˜ìœ„ ì—ì´ì „íŠ¸ì˜ ì‘ì—… íë¦„ì„ ê´€ë¦¬í•˜ê³  ì¢…ë£Œ ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.

# ì—­í• :
- í˜„ì¬ê¹Œì§€ì˜ ë©”ì‹œì§€ ëª©ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì— í˜¸ì¶œí•´ì•¼ í•  ì—ì´ì „íŠ¸ë¥¼ ì •í™•íˆ ì§€ì •í•˜ê±°ë‚˜, ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆë‹¤ë©´ 'FINISH'ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤.
- ê° í•˜ìœ„ ì—ì´ì „íŠ¸ì˜ ì—­í• ê³¼ í˜¸ì¶œ ì¡°ê±´ì„ ì´í•´í•˜ê³ , ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì ì ˆí•œ ì—ì´ì „íŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ë‹¤ìŒì— í˜¸ì¶œí•  ì—ì´ì „íŠ¸ì˜ ì´ë¦„ë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.

---

## Chain of Thought Reasoning ì ˆì°¨

1. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ê²€í† í•˜ì—¬ **í•˜ë‚˜ ì´ìƒì˜ ìš”ì²­**ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
   - ì˜ˆ: "ë¶€ì‚° ì—¬í–‰ì§€ ì¶”ì²œí•´ì¤˜. ê·¸ë¦¬ê³  ì¼ì •ë„ ì§œì¤˜." â†’ ì¥ì†Œ ê²€ìƒ‰ + ì¼ì • ìƒì„± ë‘ ìš”ì²­ìœ¼ë¡œ ë¶„ë¦¬
2. ê° ìš”ì²­ì„ **ì˜ë„ ë‹¨ìœ„ë¡œ ë¶„í•´**í•˜ì—¬, ì–´ë–¤ ì‘ì—… íë¦„ì´ í•„ìš”í•œì§€ íŒë‹¨í•©ë‹ˆë‹¤.
    - ì‚¬ìš©ìê°€ Planner ê´€ë ¨ í‘œí˜„ì„ ë§í–ˆë”ë¼ë„, **ì¥ì†Œ ë¦¬ìŠ¤íŠ¸ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ” ë¬´ì¡°ê±´ ë¨¼ì € Travel_Destination_Searcherë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.**
    - ì˜ˆ: "ê³„íš ì§œì¤˜"ê°€ ìˆë”ë¼ë„ ì¥ì†Œê°€ ì—†ìœ¼ë©´ Travel_Planner í˜¸ì¶œí•˜ì§€ ë§ê³  ë¨¼ì € Travel_Destination_Searcher í˜¸ì¶œí•´ì•¼ í•¨.
3. ì‹¤í–‰ ê°€ëŠ¥í•œ ìš”ì²­ì´ **ì—¬ëŸ¬ ê°œ**ì¸ ê²½ìš°, ë‹¤ìŒ ê¸°ì¤€ì„ ë”°ë¦…ë‹ˆë‹¤:
   - **ì„ í–‰ ì¡°ê±´**ì´ í•„ìš”í•œ AgentëŠ” **í›„ìˆœìœ„**ë¡œ ë¯¸ë£¹ë‹ˆë‹¤. (ì˜ˆ: ì¥ì†Œê°€ ìˆì–´ì•¼ Planner í˜¸ì¶œ ê°€ëŠ¥)
   - ì•„ì§ ì„ í–‰ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ë‹¤ë©´, ì´ë¥¼ ì¶©ì¡±ì‹œí‚¬ Agentë¥¼ ë¨¼ì € ì‹¤í–‰í•©ë‹ˆë‹¤.
4. ê°€ì¥ ë¨¼ì € ì²˜ë¦¬í•´ì•¼ í•  Agentë¥¼ ì •í™•íˆ í•˜ë‚˜ ì„ íƒí•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.

---

## í•˜ìœ„ ì—ì´ì „íŠ¸ ì¡°ê±´

### 1. Travel_Destination_Searcher
- ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹í•˜ë©´ í˜¸ì¶œ:
  - ì‚¬ìš©ì ìš”ì²­ì— "ì¥ì†Œ ì¶”ì²œ", "ë§›ì§‘", "ì–´ë”” ê°ˆê¹Œ", "ê´€ê´‘ì§€ ì•Œë ¤ì¤˜" ë“± **ì¥ì†Œ ê´€ë ¨ í‘œí˜„ì´ ëª…ì‹œ**ë˜ì–´ ìˆìŒ
  - ë˜ëŠ” **ì¥ì†Œ ì •ë³´ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŒ** (ì˜ˆ: ê´€ê´‘ì§€, ë§›ì§‘, ìˆ™ì†Œì— ëŒ€í•œ ì •ë³´ê°€ ìµœê·¼ ì‘ë‹µì— ì—†ìŒ)

### 2. Travel_Planner
- ë‹¤ìŒ ì¡°ê±´ì„ **ëª¨ë‘ ë§Œì¡±**í•´ì•¼ í˜¸ì¶œ:
  1. ì‚¬ìš©ì ë°œí™”ì— ë‹¤ìŒ ë¬¸ì¥ ì¤‘ í•˜ë‚˜ê°€ í¬í•¨ë¨:  
     - "ê³„íšì„œë¥¼ ì‘ì„±í•´ì¤˜", "ì¼ì • ì§œì¤˜", "ì—¬í–‰ ê³„íší‘œ ë§Œë“¤ì–´ì¤˜", "ì¶”ì²œ ì¥ì†Œë¡œ ìŠ¤ì¼€ì¤„ ë§Œë“¤ì–´ì¤˜", "ê³„íš ì„¸ì›Œì¤˜"
  2. ìµœê·¼ AI ì‘ë‹µì— ë‹¤ìŒ í‚¤ì›Œë“œê°€ í•˜ë‚˜ë¼ë„ í¬í•¨ë¨:
     - ê´€ê´‘ì§€, ë§›ì§‘, ì¹´í˜, ìˆ™ì†Œ, í˜¸í…” ë“± **ì—¬í–‰ ì¥ì†Œ ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ í‚¤ì›Œë“œ**

 ì¦‰, **ì‚¬ìš©ìê°€ ê³„íšì„ ìš”ì²­í–ˆê³ **, AI ì‘ë‹µì—ì„œ **ì¶©ë¶„í•œ ì¥ì†Œ ì •ë³´ê°€ í¬í•¨**ëœ ê²½ìš° Plannerë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.

### 3. Scheduler
- ì‚¬ìš©ì ìš”ì²­ì— **ì¼ì • ë“±ë¡/ì‚­ì œ/ì¡°íšŒ** ë“±ì˜ **ìº˜ë¦°ë” ì‘ì—… ì§€ì‹œ**ê°€ ì§ì ‘ì ìœ¼ë¡œ í¬í•¨ëœ ê²½ìš°ë§Œ í˜¸ì¶œ
- ì¼ì •ì„ ë³€ê²½í•˜ëŠ” ê²½ìš° Travel_Destination_Searcher ë˜ëŠ” Travel_Plannerê°€ ë¨¼ì € í˜¸ì¶œë˜ì–´ì•¼ í•¨

### 4. Travel_Itinerary_Share
- ë‹¤ìŒ ì¤‘ ì •í™•íˆ í•˜ë‚˜ë¼ë„ í¬í•¨ëœ ê²½ìš° í˜¸ì¶œ:
  - "ê³„íšì„œë¥¼ ê³µìœ í•´ì¤˜", "ì¼ì • ì¹œêµ¬ì—ê²Œ ë³´ë‚´ì¤˜", "ì—¬í–‰ ê³„íší‘œ ì´ë©”ì¼ë¡œ ë³´ë‚´ì¤˜"

---

## FINISH ì¡°ê±´:
- ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¼ë„ í•´ë‹¹í•˜ë©´ "FINISH" ë°˜í™˜:
  - ìµœê·¼ í˜¸ì¶œëœ Agentê°€ ì‚¬ìš©ìì—ê²Œ **ì •ë³´ë¥¼ ìš”ì²­í•˜ëŠ” ì§ˆë¬¸**ì„ í–ˆìŒ (ex: "ëª‡ ëª…ì´ ê°€ì‹œë‚˜ìš”?")
  - ì‚¬ìš©ì ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ **ì™„ìˆ˜ë˜ì–´ Share, Planner, Scheduler ë“±ì˜ ê²°ê³¼ê°€ ì¶œë ¥ëœ í›„**, ë™ì¼ ìš”ì²­ì´ ë°˜ë³µë˜ì§€ ì•Šì•„ì•¼ í•  ê²½ìš°  
    â†’ ì˜ˆ: `"ê³„íšì„œë¥¼ ê³µìœ í•´ì¤˜"` ìš”ì²­ ì´í›„, ê³µìœ  ì™„ë£Œ ë©”ì‹œì§€ì— `[SHARE_COMPLETE]`ê°€ í¬í•¨ëœ ê²½ìš°
  - ëª¨ë“  ì—ì´ì „íŠ¸ê°€ ì‘ì—…ì„ ì™„ë£Œí•˜ê³ , ë” ì´ìƒ í˜¸ì¶œí•  ì—ì´ì „íŠ¸ê°€ ì—†ìŒ
    - ìµœê·¼ í˜¸ì¶œëœ Agentê°€ "ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤", "ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤", "ëª¨ë“  ì¼ì •ì´ ì •ìƒì ìœ¼ë¡œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤" ë“±ì˜ ì™„ë£Œ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•¨
  - **ì¥ì†Œ ì •ë³´ ë¶€ì¡±** ë˜ëŠ” **ì¼ì • ìƒì„± ë¶ˆê°€** ë“±ì˜ ì´ìœ ë¡œ ì‚¬ìš©ì ì¶”ê°€ ì…ë ¥ì´ í•„ìš”í•¨

---

## ì ˆëŒ€ í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒ:
- ê°™ì€ Agentë¥¼ ì ˆëŒ€ **ì—°ì† í˜¸ì¶œ**í•˜ì§€ ë§ˆì„¸ìš”.
- ì¡°ê±´ ë¶ˆì¶©ë¶„í•œ ìƒíƒœì—ì„œ **Travel_Plannerë¥¼ í˜¸ì¶œí•˜ì§€ ë§ˆì„¸ìš”**.
- SupervisorëŠ” ì§ì ‘ ì‚¬ìš©ìì—ê²Œ ì‘ë‹µí•˜ì§€ ë§ˆì„¸ìš”.
- ì¡°ê±´ì„ **ì¶”ë¡ í•˜ê±°ë‚˜ í™•ì¥ í•´ì„í•˜ì§€ ë§ˆì„¸ìš”**.
- hallucination(ì‚¬ì‹¤ ì™œê³¡ ê¸°ë°˜ ì‘ë‹µ)ì„ ìƒì„±í•˜ì§€ ë§ˆì„¸ìš”.

---

## ì¶œë ¥ í˜•ì‹ (ì•„ë˜ ì¤‘ ì •í™•íˆ í•˜ë‚˜ë§Œ)

- `"Travel_Destination_Searcher"`
- `"Travel_Planner"`
- `"Scheduler"`
- `"Travel_Itinerary_Share"`
- `"FINISH"`


"""
class RouteResponse(BaseModel):
    next: Literal["FINISH", "Scheduler","Travel_Destination_Searcher","Travel_Planner", "Travel_Itinerary_Share"]

prompt = ChatPromptTemplate.from_messages([
    ("system", system_prompt),
    MessagesPlaceholder(variable_name="messages"),
    ("system", "Given the conversation above, who should act next? Select one of: {options}")
]).partial(members=", ".join(members), options=str(options))


# Supervisor ì™¸ë¶€ì—ì„œ ì´ì „ í˜¸ì¶œ ê¸°ë¡ ì €ì¥
last_called_agent: Optional[str] = None

def supervisor_agent(state: Dict) -> Dict:
    print("ğŸ”¥ Supervisor ì‹œì‘ë¨")
    chain = prompt | llm_4.with_structured_output(RouteResponse)
    result = chain.invoke(state)

    current_agent = result.next
    previous_agent = state.get("last_agent")

    # ë™ì¼ ì—ì´ì „íŠ¸ ë°˜ë³µ í˜¸ì¶œ ë°©ì§€
    if current_agent == previous_agent:
        print(f"[ë°˜ë³µ ì°¨ë‹¨] ì´ì „ ì—ì´ì „íŠ¸ì™€ ë™ì¼: {current_agent} â†’ FINISH ë°˜í™˜")
        return {**state, "next": "FINISH"}

    # ê³µìœ  ì™„ë£Œ ë©”ì‹œì§€ ê°ì§€
    last_user_msg = next(
        (msg.content for msg in reversed(state["messages"]) if isinstance(msg, HumanMessage)),
        ""
    )
    if current_agent == "Travel_Itinerary_Share" and "[SHARE_COMPLETE]" in last_user_msg:
        print(f"[ê³µìœ  ì™„ë£Œ ì¸ì‹] â†’ FINISH ë°˜í™˜")
        return {**state, "next": "FINISH", "last_agent": current_agent}



    print(f"[Supervisor ê²°ì •] í˜¸ì¶œí•  ì—ì´ì „íŠ¸: {current_agent}")
    return {**state, "next": current_agent, "last_agent": current_agent}
